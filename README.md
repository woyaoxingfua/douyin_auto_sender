# 抖音PC客户端 - 每日天气助手-自动续火花 (增强版)

本项目是一个经过重构和优化的 Python 桌面UI自动化工具，旨在每日定时向指定的抖音好友发送其所在城市的天气预报。通过结合和风天气API、图形用户界面(GUI)配置工具以及 PyAutoGUI 库，实现高度自动化、稳定可靠的每日任务。

相较于旧版，v5.1 在**稳定性、可维护性和功能丰富性**上进行了全面升级。

## ✨ 主要功能

*   **双重运行模式**：
    *   **定时调度模式**：默认模式，启动一次主程序 (`douyin_bot.py`)，即可实现每天早上 8:00 自动执行，无需人工干预。
    *   **立即执行模式**：通过命令行参数 `--now`，可让任务立即执行一次，方便测试和按需运行。
*   **高度可配置与个性化**：
    *   **图形化配置后台** (`config_manager_gui.py`)：提供用户友好的GUI界面，轻松管理API、好友和城市信息。
    *   **自定义消息模板**：在GUI中自由编辑天气播报文案，支持多种变量，让您的问候与众不同。
*   **健壮性与稳定性增强**：
    *   **专业日志系统**：用 `logging` 模块取代了简单的 `print`，所有操作和潜在错误都会记录到 `run.log` 文件中，便于追溯和调试。
    *   **网络重试机制**：为天气API请求增加了 `tenacity` 库支持的重试功能，有效应对瞬时网络波动。
    *   **区域化图像识别**：限定 `pyautogui` 在屏幕的特定区域（如左侧列表、右下角聊天区）寻找图像，大幅提升识别速度和准确性。
    *   **优化滚动逻辑**：采用“滚轮滚动”优先、“拖拽滚动条”为备用的双重滚动策略，提高了在好友列表滚动的成功率。
*   **更佳的用户体验与安全性**：
    *   **API连通性测试**：在GUI中一键测试和风天气API Key的有效性。
    *   **敏感数据保护**：支持从环境变量 `DOUYIN_WEATHER_API_KEY` 读取API密钥，避免在配置文件中明文存储，更加安全。

## 项目结构

```
douyin_auto_sender/
│
├── douyin_bot.py               # (主程序) 自动化机器人，启动后自动调度任务
├── config_manager_gui.py       # (配置工具) 图形化配置后台
├── weather_service.py          # (模块) 封装了天气数据获取的逻辑
│
├── config.json                 # 配置文件 (由GUI生成和管理)
├── requirements.txt            # 项目依赖库
├── run.log                     # 运行日志文件
│
├── control_images/             # 存放UI控制按钮的截图
│   ├── douyin_sixin_icon.png
│   └── ...
│
└── friend_avatars/             # 存放好友头像的截图
    └── haoyou.png
    └── ...
```

## ️ 环境安装与配置

#### 1\. 软件依赖

*   **Python**: 建议使用 3.8 或更高版本。

#### 2\. Python库安装

项目依赖已全部记录在 `requirements.txt` 中。请在项目根目录打开终端，运行以下命令以安装所有必需的Python库：

```bash
pip install -r requirements.txt
```
这会安装 `pyautogui`, `requests`, `opencv-python`, `pyperclip`, `tenacity`, `schedule` 等所有必要的库。

## 📖 使用指南

#### **第一步：配置 (仅需一次或在需要修改时运行)**

1.  **运行配置工具**: 首次使用或需要修改配置时，请运行 `config_manager_gui.py` 文件。
    ```bash
    python config_manager_gui.py
    ```
2.  **填写API信息**:
    *   在弹出的 "1. 天气API配置" 窗口中，填入您从 **和风天气开发者平台** 获取的 `API Host` 和 `API Key`。
    *   点击 **"测试连接"** 按钮，确保您的API配置无误。
3.  **自定义消息模板 (可选)**:
    *   在 "2. 消息模板配置" 区域，您可以修改天气播报的文案。其中 `{nickname}`、`{city_name}` 等变量会在发送时被自动替换。
4.  **添加与管理好友**:
    *   使用 "3. 查找城市ID" 功能找到好友所在城市的ID。
    *   在 "4. 编辑好友信息" 中填写好友昵称，并关联该好友的头像截图（头像截图需提前截好并放入 `friend_avatars` 文件夹）。
    *   点击 **"添加为新好友"** 或 **"更新选中好友"**。
5.  **保存配置**: 完成所有操作后，点击 **"️ 保存所有配置并退出"**。程序会自动生成或更新 `config.json` 文件。

#### **第二步：启动自动化机器人 (选择一种模式)**

**模式一：定时调度 (长期运行)**
此模式适用于将程序部署在服务器或个人电脑上长期自动运行。

1.  **运行主程序**: 在终端中直接运行 `douyin_bot.py`。
    ```bash
    python douyin_bot.py
    ```
2.  **程序将进入后台等待**：启动后，程序会显示 "任务已调度：每天08:00执行抖音天气助手。" 的日志，然后保持运行，等待预设时间的到来。**您可以最小化此终端窗口，但不要关闭它**。

**模式二：立即执行 (用于测试或按需运行)**
此模式适用于立即测试或手动执行一次任务。

1.  **使用 `--now` 参数运行**: 在终端中运行 `douyin_bot.py` 并附带 `--now` 参数。
    ```bash
    python douyin_bot.py --now
    ```
2.  **程序将立即执行任务**：启动后，程序会显示 "接收到 --now 参数，任务将立即执行..." 的日志，然后开始执行一次完整的自动化流程。任务结束后，程序会自动退出。

## 🔒 安全建议：使用环境变量 (推荐)

为了避免 API Key 泄露，建议您使用环境变量来存储它，而不是保存在 `config.json` 中。

1.  **设置环境变量**:
    *   **Windows**: `set DOUYIN_WEATHER_API_KEY=你的APIKey` (临时) 或在系统属性中设置 (永久)。
    *   **macOS/Linux**: `export DOUYIN_WEATHER_API_KEY="你的APIKey"`
2.  **程序将自动优先使用**：如果检测到 `DOUYIN_WEATHER_API_KEY` 这个环境变量，`douyin_bot.py` 会优先使用它，并忽略配置文件中的 `api_key` 字段。

## ️ 注意事项

*   **截图精度**: 程序的识别成功率与您的截图精度直接相关。如果某个按钮找不到，请尝试重新截取。
*   **界面更新**: 如果抖音PC客户端版本更新导致UI发生变化，您可能需要重新截取对应的控制图片，并存放在 `control_images` 文件夹中。
*   **紧急停止**: 程序内置了 `pyautogui.FAILSAFE` 机制。在自动化任务执行期间，如果您想紧急停止，只需将鼠标指针**猛地移动到屏幕的左上角**即可。
*   **日志查看**: 如果程序运行异常，请打开项目根目录下的 `run.log` 文件，查看详细的错误信息。

-----

*作者GitHub-https://github.com/woyaoxingfua*
*AI重构与优化 - Gemini*